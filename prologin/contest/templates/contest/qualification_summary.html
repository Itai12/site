{% extends "prologin/base.html" %}
{% load i18n static django_bootstrap_breadcrumbs bootstrap %}

{% block breadcrumbs %}
  {{ block.super }}
  {% breadcrumb_for "" %}{% trans "Contest" %}{% endbreadcrumb_for %}
  {% breadcrumb request.current_edition.year "" %}
  {% breadcrumb_for "" %}{% trans "Qualification" %}{% endbreadcrumb_for %}
  {% breadcrumb_for "contest:qualification-summary" request.current_edition.year %}{% trans "Application summary" %}{% endbreadcrumb_for %}
{% endblock breadcrumbs %}

{% block extra_head %}
  <link href="{% static 'lib/css/select2.min.css' %}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block title %}{% blocktrans with request.current_edition.year as year %}Application summary â€“ Prologin {{ year }}{% endblocktrans %}{% endblock %}

{% block content %}

  <h1>{% blocktrans with request.current_edition.year as year %}Application summary for Prologin {{ year }}{% endblocktrans %}</h1>

  {% url 'pages:about-semifinals' as about_regional_url %}
  <p>{% blocktrans %}Thanks for joining the Prologin contest this year! This page sums up the requirements you have
  to fulfill so you can be selectionned to participate in the next step: <a href="{{ about_regional_url }}">regional events</a>.{% endblocktrans %}</p>
  <p class="well">
    <span class="label label-info">{% trans "Heads up!" %}</span>
    {% blocktrans with request.current_events.qualification.date_end|date:'DATETIME_FORMAT' as end_date %}The qualification step ends <strong>{{ end_date }}</strong>. Be sure to have the green light on this page before this date!{% endblocktrans %}
  </p>

  <h2>{% trans "Complete the exercices, as best as you can" %}</h2>
  <div class="row">
  {% if request.current_qcm %}
    <div class="col-md-6">
      <div class="panel panel-default">
        <div class="panel-heading">
          {% if quiz_completed %}
            <span class="pull-right label label-success"><i class="fa fa-check"></i> {% trans "Completed" %}</span>
          {% else %}
            <span class="pull-right label label-warning"><i class="fa fa-warning"></i> {% trans "Incomplete" %}</span>
          {% endif %}
          {% trans "The quiz" %}
        </div>
        <div class="panel-body">
          <p>
            {% blocktrans count request.current_qcm.question_count as count %}There is {{ count }} quiz question this year.{% plural %}There are {{ count }} quiz questions this year.{% endblocktrans %}
            {% blocktrans count completed_quiz_question_count as count %}You completed {{ count }} question.{% plural %}You completed {{ count }} questions.{% endblocktrans %}
          </p>
          <p>
          {% url 'qcm:display' request.current_edition.year as quiz_url %}
          {% if quiz_completed %}
            <a href="{{ quiz_url }}" class="btn btn-primary"><i class="fa fa-pencil"></i> {% trans "Review answers" %}</a>
          {% else %}
            <a href="{{ quiz_url }}" class="btn btn-primary"><i class="fa fa-pencil"></i> {% trans "Complete answers" %}</a>
          {% endif %}
          </p>
          <p class="text-muted">{% blocktrans %}Although you are not required to answer all questions, it is recommended to answer as many as you can to improve you chances of being selected.{% endblocktrans %}</p>
        </div>
      </div>
    </div>
  {% endif %}
    <div class="col-md-6">
      <div class="panel panel-default">
        <div class="panel-heading">
          {% if problems_completed %}
            <span class="pull-right label label-success"><i class="fa fa-check"></i> {% trans "Completed" %}</span>
          {% else %}
            <span class="pull-right label label-warning"><i class="fa fa-warning"></i> {% trans "Incomplete" %}</span>
          {% endif %}
          {% trans "The problems" %}
        </div>
        <div class="panel-body">
          <p>
            {% blocktrans count problem_count as count %}There is {{ count }} problem this year.{% plural %}There are {{ count }} problems this year.{% endblocktrans %}
            {% blocktrans count completed_problem_count as count %}You completed {{ count }} problem.{% plural %}You completed {{ count }} problems.{% endblocktrans %}
          </p>
          <p>
          {% url 'training:challenge' request.current_edition.year 'qualification' as problem_url %}
          {% if problems_completed %}
            <a href="{{ problem_url }}" class="btn btn-primary"><i class="fa fa-pencil"></i> {% trans "Review submissions" %}</a>
          {% else %}
            <a href="{{ problem_url }}" class="btn btn-primary"><i class="fa fa-pencil"></i> {% trans "Complete submissions" %}</a>
          {% endif %}
          </p>
          <p class="text-muted">{% blocktrans %}Your submissions do not have to pass all the tests. Nevertheless, the jury will favor codes that both compile, answer the statement and have a minimal runtime/memory complexity. You are even free to submit pseudo-code but keep in mind that you will have to write actual code for the regional events and the finale.{% endblocktrans %}</p>
        </div>
      </div>
    </div>
  </div>

  <h2>{% trans "Fill in the extra details" %}
    {% if form.is_valid or not form.is_bound %}<div style="font-size: 1ex;" class="pull-right">{% if contestant.is_complete_for_semifinal %}
      <span class="label label-success"><i class="fa fa-check"></i> {% trans "Completed" %}</span>
    {% else %}
      <span class="label label-warning"><i class="fa fa-warning"></i> {% trans "Incomplete" %}</span>
    {% endif %}</div>{% endif %}
  </h2>
  <form method="POST" class="form-horizontal">
    {% csrf_token %}
    {{ form|bootstrap_horizontal }}
    <div class="form-group">
      <div class="col-sm-offset-2 col-sm-10">
        <button type="submit" class="btn btn-primary"><i class="fa fa-paper-plane-o"></i> {% trans "Save application" %}</button>
      </div>
    </div>
  </form>

{% endblock %}

{% block extra_script %}
  <script src="{% static 'lib/js/select2.min.js' %}"></script>
  <script type="text/javascript">
    {# Some logic to prevent user from selecting the same event twice in the wish selects #}
    $(function () {
      var opts = {placeholder: '{% trans "Make your choice" %}', allowClear: true};
      $('select[name="preferred_language"]').select2(opts);
      var $event_wish_selects = $('.event-wish-select');
      $event_wish_selects
          .select2($.extend(opts, {
            templateResult: function (state) {
              console.log(state.element);
              var e = $(state.element);
              var $name = $('<strong>').text(e.attr('data-name'));
              var $addr = $('<span>').addClass('text-muted').text(e.attr('data-addr'));
              return $('<span>').append($name).append('<br>').append($addr);
            }
          }))
          .on('change', function () {
            var taken_vals = [];
            $event_wish_selects.each(function (i, select) {
              taken_vals.push($(select).val());
            });
            $event_wish_selects.each(function (i, select) {
              var $select = $(select);
              $select.select2('destroy'); // because this shit plugin does not propagates 'disabled'
              $select.find('option').prop('disabled', false);
              $.each(taken_vals, function (j, val) {
                if (val === "" || i == j) return; // self
                $select.find('option[value="' + val + '"]').prop('disabled', true);
              });
              $select.select2(opts); // so we have to recreate the shit everytime
            });
          }).trigger('change');
    });
  </script>
{% endblock %}
